#!/bin/bash
# Source https://github.com/cadorn/bash.origin
. "$HOME/.bash.origin"
function init {
	eval BO_SELF_BASH_SOURCE="$BO_READ_SELF_BASH_SOURCE"
	BO_deriveSelfDir ___TMP___ "$BO_SELF_BASH_SOURCE"
	local __BO_DIR__="$___TMP___"


	if [ ! -e "$__BO_DIR__/../.pgs/.provisioned" ]; then
		echo "ERROR: Cannot link globally. Not provisioned. Call './boot turn' first!"
		exit 1
	fi

	rm -Rf "$HOME/.bash.origin" > /dev/null || true
	ln -s "$__BO_DIR__/../.deps/github.com~bash-origin~bash.origin~0/source/installed/master/bash.origin" "$HOME/.bash.origin"

	if [ ! -e "$HOME/.bash.origin.cache" ]; then
		mkdir "$HOME/.bash.origin.cache"
	fi

	pushd "$HOME/.bash.origin.cache" > /dev/null
		BO_log "$VERBOSE" "Link '$__BO_DIR__/..' to '$HOME/.bash.origin.cache/github.com~pinf~genesis.pinf.org~0/source/installed/master'."
		if [ -d "github.com~pinf~genesis.pinf.org~0/source/installed" ]; then
			rm -Rf "github.com~pinf~genesis.pinf.org~0/source/installed/master" > /dev/null || true
		else
			mkdir -p "github.com~pinf~genesis.pinf.org~0/source/installed"
		fi
		ln -s "$__BO_DIR__/.." "github.com~pinf~genesis.pinf.org~0/source/installed/master"

		for dir in $__BO_DIR__/../.deps/* ; do
			dir="$(basename $dir)"
			BO_log "$VERBOSE" "Link '$__BO_DIR__/../.deps/$dir' to '$HOME/.bash.origin.cache/$dir'."
			rm -Rf "$dir" > /dev/null || true
			ln -s "$__BO_DIR__/../.deps/$dir" "$dir"
		done
	popd > /dev/null
}
init $@